<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#111b21">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>WOR Remote</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #111b21;
      color: #e9edef;
      min-height: 100vh;
      padding-bottom: 70px;
    }
    
    .header {
      background: #202c33;
      padding: 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid #2a3942;
    }
    
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      background: #2a3942;
    }
    
    .status-badge.monitoring { background: #00a884; color: #111b21; }
    .status-badge.paused { background: #f7c32e; color: #111b21; }
    .status-badge.processing { background: #53bdeb; color: #111b21; }
    .status-badge.awaiting { background: #ff9500; color: #111b21; }
    .status-badge.stopped { background: #667781; }
    .status-badge.disconnected { background: #ea4b35; }
    
    .session-id-display {
      font-size: 11px;
      color: #8696a0;
      margin-top: 4px;
    }
    
    .controls {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #1f2c34;
    }
    
    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn-primary { background: #00a884; color: #111b21; }
    .btn-secondary { background: #2a3942; color: #e9edef; }
    .btn-danger { background: #ea4b35; color: #fff; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .tabs {
      display: flex;
      background: #202c33;
      border-bottom: 1px solid #2a3942;
    }
    
    .tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: none;
      color: #8696a0;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      color: #00a884;
      border-bottom-color: #00a884;
    }
    
    .tab-content {
      display: none;
      padding: 16px;
    }
    
    .tab-content.active { display: block; }
    
    .queue-item {
      background: #202c33;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
    }
    
    .queue-item.working {
      background: #1a3a4a;
      border: 1px solid #00a884;
    }
    
    .queue-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .queue-item-title {
      font-weight: 600;
      font-size: 14px;
    }
    
    .queue-item-time {
      font-size: 11px;
      color: #8696a0;
    }
    
    .queue-item-preview {
      font-size: 13px;
      color: #8696a0;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .queue-item-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .queue-item-actions .btn {
      flex: 1;
      padding: 10px;
      font-size: 13px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #8696a0;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .approval-section {
      padding: 16px;
      background: #1f2c34;
      border-bottom: 1px solid #2a3942;
    }
    
    .approval-section.hidden { display: none; }
    
    .approval-card {
      background: #202c33;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #00a884;
    }
    
    .approval-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .approval-type {
      font-weight: 600;
      font-size: 14px;
    }
    
    .approval-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .approval-subtitle {
      font-size: 13px;
      color: #8696a0;
      margin-bottom: 12px;
    }
    
    .approval-textarea {
      width: 100%;
      min-height: 120px;
      background: #111b21;
      border: 1px solid #2a3942;
      border-radius: 8px;
      padding: 12px;
      color: #e9edef;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 12px;
    }
    
    .approval-input {
      width: 100%;
      background: #111b21;
      border: 1px solid #2a3942;
      border-radius: 8px;
      padding: 12px;
      color: #e9edef;
      font-size: 14px;
      margin-bottom: 12px;
    }
    
    .approval-actions {
      display: flex;
      gap: 8px;
    }
    
    .label-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .label-chip {
      background: #2a3942;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .label-chip.selected {
      border-color: #00a884;
      background: #00a88420;
    }
    
    .price-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #00a884;
      color: #111b21;
    }
    
    .price-badge.remove { background: #ea4b35; color: #fff; }
    .price-badge.keep { background: #00a884; color: #111b21; }
    
    .connection-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .connection-screen.hidden { display: none; }
    
    .connection-logo {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .connection-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .connection-subtitle {
      color: #8696a0;
      margin-bottom: 24px;
      text-align: center;
    }
    
    .connection-input {
      width: 100%;
      max-width: 280px;
      padding: 16px;
      font-size: 24px;
      text-align: center;
      background: #202c33;
      border: 2px solid #2a3942;
      border-radius: 12px;
      color: #e9edef;
      letter-spacing: 8px;
      margin-bottom: 16px;
      text-transform: uppercase;
    }
    
    .connection-input:focus {
      outline: none;
      border-color: #00a884;
    }
    
    .connect-btn {
      width: 100%;
      max-width: 280px;
      padding: 16px;
      font-size: 16px;
    }
    
    .main-app { display: none; }
    .main-app.active { display: block; }
    
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #202c33;
      color: #e9edef;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, 10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
    
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    
    .settings-modal.hidden { display: none; }
    
    .settings-content {
      background: #202c33;
      border-radius: 16px;
      width: 90%;
      max-width: 340px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px;
    }
    
    .settings-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .settings-group {
      margin-bottom: 16px;
    }
    
    .settings-label {
      font-size: 13px;
      color: #8696a0;
      margin-bottom: 8px;
    }
    
    .settings-value {
      background: #111b21;
      padding: 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .settings-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 20px;
    }
    
    .notification-banner {
      background: #00a884;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    
    .notification-banner.hidden { display: none; }
    
    .notification-banner-text {
      font-size: 13px;
      color: #111b21;
      font-weight: 500;
    }
    
    .notification-banner .btn {
      flex: 0;
      white-space: nowrap;
      background: #111b21;
      color: #e9edef;
    }
    
    .debug-log {
      background: #0a1014;
      border-radius: 8px;
      padding: 10px;
      font-family: monospace;
      font-size: 10px;
      max-height: 200px;
      overflow-y: auto;
      color: #8696a0;
      white-space: pre-wrap;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <!-- Connection Screen -->
  <div class="connection-screen" id="connection-screen">
    <div class="connection-logo">üì±</div>
    <div class="connection-title">WOR Remote</div>
    <div class="connection-subtitle">Enter the Session ID from your<br>Chrome extension to connect</div>
    <input type="text" class="connection-input" id="session-input" placeholder="XXXXXX" maxlength="6" autocomplete="off">
    <button class="btn btn-primary connect-btn" onclick="connect()">Connect</button>
  </div>
  
  <!-- Main App -->
  <div class="main-app" id="main-app">
    <!-- Header -->
    <div class="header">
      <div class="header-row">
        <h1>üì± WOR Remote</h1>
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="status-badge" id="status-badge" onclick="refreshStatus()" style="cursor:pointer;">Connecting...</span>
          <button onclick="refreshStatus()" style="background:none;border:none;font-size:14px;cursor:pointer;" title="Refresh Status">üîÑ</button>
          <button onclick="showSettings()" style="background:none;border:none;font-size:18px;cursor:pointer;">‚öôÔ∏è</button>
        </div>
      </div>
      <div class="session-id-display">Session: <span id="session-display">------</span></div>
    </div>
    
    <!-- Notification Banner -->
    <div class="notification-banner" id="notification-banner">
      <span class="notification-banner-text">üîî Enable notifications for new offers</span>
      <button class="btn" onclick="requestNotificationPermission()">Enable</button>
    </div>
    
    <!-- Approval Section -->
    <div class="approval-section hidden" id="approval-section"></div>
    
    <!-- Controls -->
    <div class="controls">
      <button class="btn btn-primary" id="btn-run" onclick="sendCommand('RUN')">‚ñ∂ Run</button>
      <button class="btn btn-secondary" id="btn-pause" onclick="sendCommand('PAUSE')">‚è∏ Pause</button>
      <button class="btn btn-danger" id="btn-stop" onclick="sendCommand('STOP')">‚èπ Stop</button>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="pending" onclick="switchTab('pending')">
        Pending <span id="pending-badge"></span>
      </button>
      <button class="tab" data-tab="completed" onclick="switchTab('completed')">
        Done <span id="completed-badge"></span>
      </button>
    </div>
    
    <!-- Pending Tab -->
    <div class="tab-content active" id="tab-pending">
      <div id="pending-list">
        <div class="empty-state">
          <div class="empty-state-icon">üì≠</div>
          <p>No pending offers</p>
        </div>
      </div>
    </div>
    
    <!-- Completed Tab -->
    <div class="tab-content" id="tab-completed">
      <div id="completed-list">
        <div class="empty-state">
          <div class="empty-state-icon">‚úÖ</div>
          <p>No completed offers today</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div class="settings-modal hidden" id="settings-modal">
    <div class="settings-content">
      <div class="settings-title">‚öôÔ∏è Settings</div>
      <div class="settings-group">
        <div class="settings-label">Session ID</div>
        <div class="settings-value">
          <span id="settings-session-id">------</span>
          <button class="btn btn-secondary" onclick="copySessionId()" style="padding:6px 12px;font-size:12px;">Copy</button>
        </div>
      </div>
      <div class="settings-group">
        <div class="settings-label">Notifications</div>
        <div class="settings-value">
          <span id="notification-status">Not enabled</span>
          <button class="btn btn-secondary" onclick="testNotification()" style="padding:6px 12px;font-size:12px;">Test</button>
        </div>
      </div>
      <div class="settings-group">
        <div class="settings-label">Debug Log</div>
        <div class="debug-log" id="debug-log">Waiting for events...</div>
      </div>
      <div class="settings-actions">
        <button class="btn btn-secondary" onclick="hideSettings()">Close</button>
        <button class="btn btn-danger" onclick="disconnect()">Disconnect</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script>
    // Debug logging
    const debugLog = document.getElementById('debug-log');
    function log(msg) {
      console.log('[WOR]', msg);
      const time = new Date().toLocaleTimeString();
      const line = time + ': ' + msg;
      debugLog.textContent = line + '\n' + debugLog.textContent;
      // Keep only last 100 lines
      const lines = debugLog.textContent.split('\n');
      if (lines.length > 100) {
        debugLog.textContent = lines.slice(0, 100).join('\n');
      }
      // Also log to Android if available
      if (typeof Android !== 'undefined' && Android.log) {
        Android.log(msg);
      }
    }
    
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBSOUq1_RXB8SpkDdRzSXgksBUudiV4l4g",
      authDomain: "wor-remote.firebaseapp.com",
      databaseURL: "https://wor-remote-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wor-remote"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    log('Firebase initialized');
    
    // State
    let sessionId = localStorage.getItem('wor_session_id') || '';
    let currentStatus = 'disconnected';
    let pendingQueue = [];
    let completedToday = [];
    let currentApproval = null;
    let unsubscribers = [];
    let lastKnownOfferIds = new Set(JSON.parse(localStorage.getItem('wor_known_offers') || '[]'));
    let notificationsEnabled = false;
    let isFirstLoad = true;
    let lastPendingCount = 0;
    let workingOfferId = null;  // Track which offer is currently being worked on
    
    // DOM elements
    const connectionScreen = document.getElementById('connection-screen');
    const mainApp = document.getElementById('main-app');
    const sessionInput = document.getElementById('session-input');
    const statusBadge = document.getElementById('status-badge');
    const sessionDisplay = document.getElementById('session-display');
    const pendingList = document.getElementById('pending-list');
    const completedList = document.getElementById('completed-list');
    const approvalSection = document.getElementById('approval-section');
    const notificationBanner = document.getElementById('notification-banner');
    
    // Check for saved session on load
    if (sessionId) {
      sessionInput.value = sessionId;
      connect();
    }
    
    // Check notification permission
    checkNotificationPermission();
    
    function checkNotificationPermission() {
      // Check if running in Android WebView
      if (typeof Android !== 'undefined' && Android.showNotification) {
        log('Android native notifications available');
        notificationsEnabled = true;
        notificationBanner.classList.add('hidden');
        document.getElementById('notification-status').textContent = 'Native ‚úì';
        return;
      }
      
      if (!('Notification' in window)) {
        log('Notifications not supported in this browser');
        notificationBanner.classList.add('hidden');
        document.getElementById('notification-status').textContent = 'Use app';
        return;
      }
      
      log('Notification permission: ' + Notification.permission);
      
      if (Notification.permission === 'granted') {
        notificationsEnabled = true;
        notificationBanner.classList.add('hidden');
        document.getElementById('notification-status').textContent = 'Enabled ‚úì';
      } else if (Notification.permission === 'denied') {
        notificationBanner.classList.add('hidden');
        document.getElementById('notification-status').textContent = 'Blocked ‚úó';
      } else {
        document.getElementById('notification-status').textContent = 'Not enabled';
      }
    }
    
    function requestNotificationPermission() {
      log('Requesting notification permission...');
      
      // Check if running in Android WebView - use native notifications
      if (typeof Android !== 'undefined' && Android.showNotification) {
        log('Android WebView detected - using native notifications');
        notificationsEnabled = true;
        notificationBanner.classList.add('hidden');
        document.getElementById('notification-status').textContent = 'Native ‚úì';
        showToast('Native notifications enabled!');
        Android.showNotification('WOR Remote', 'Notifications are now enabled! üéâ');
        return;
      }
      
      if (!('Notification' in window)) {
        showToast('Use the native Android app for notifications');
        return;
      }
      
      Notification.requestPermission().then(permission => {
        log('Permission result: ' + permission);
        
        if (permission === 'granted') {
          notificationsEnabled = true;
          notificationBanner.classList.add('hidden');
          document.getElementById('notification-status').textContent = 'Enabled ‚úì';
          showToast('Notifications enabled!');
          sendNotification('WOR Remote', 'Notifications are now enabled! üéâ');
        } else {
          showToast('Permission denied');
        }
        checkNotificationPermission();
      });
    }
    
    function testNotification() {
      log('Testing notification...');
      sendNotification('Test Notification', 'If you see this, notifications work! üîî');
      showToast('Test notification sent');
    }
    
    function sendNotification(title, body) {
      log('sendNotification: ' + title + ' - ' + body);
      
      // Try native Android notification first
      if (typeof Android !== 'undefined' && Android.showNotification) {
        log('Using Android native notification');
        Android.showNotification(title, body);
        return;
      }
      
      // Fall back to web notification
      if (!('Notification' in window)) {
        log('Web notifications not supported');
        return;
      }
      
      if (Notification.permission !== 'granted') {
        log('Web notifications not granted');
        return;
      }
      
      try {
        const notification = new Notification(title, {
          body: body,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23111b21" width="100" height="100" rx="20"/><text x="50" y="65" font-size="50" text-anchor="middle">üì±</text></svg>',
          tag: 'wor-' + Date.now(),
          requireInteraction: true
        });
        
        notification.onclick = function() {
          window.focus();
          notification.close();
        };
        
        log('Web notification created');
      } catch (err) {
        log('Notification error: ' + err.message);
      }
    }
    
    // Connect to session
    function connect() {
      const input = sessionInput.value.trim().toUpperCase();
      if (input.length !== 6) {
        showToast('Enter a 6-character Session ID');
        return;
      }
      
      sessionId = input;
      localStorage.setItem('wor_session_id', sessionId);
      
      // Save to Android app if available
      if (typeof Android !== 'undefined' && Android.saveSession) {
        Android.saveSession(sessionId);
        log('Session saved to Android');
      }
      
      log('Connecting to session: ' + sessionId);
      
      // Show main app
      connectionScreen.classList.add('hidden');
      mainApp.classList.add('active');
      sessionDisplay.textContent = sessionId;
      document.getElementById('settings-session-id').textContent = sessionId;
      
      // Subscribe to Firebase
      subscribeToSession();
    }
    
    // Inject session from Android app
    function injectSession(id) {
      log('Session injected from Android: ' + id);
      if (id && id.length === 6) {
        sessionInput.value = id;
        connect();
      }
    }
    
    // Subscribe to session data
    function subscribeToSession() {
      // Unsubscribe from any previous subscriptions
      unsubscribers.forEach(unsub => unsub());
      unsubscribers = [];
      isFirstLoad = true;
      lastPendingCount = 0;
      
      const sessionRef = db.ref(`sessions/${sessionId}`);
      
      // Listen to status
      const statusRef = sessionRef.child('status');
      statusRef.on('value', (snapshot) => {
        const data = snapshot.val();
        log('Status update: ' + JSON.stringify(data));
        
        if (data) {
          // Extension stores as {status: 'monitoring', timestamp: ...}
          if (typeof data === 'object' && data.status) {
            currentStatus = data.status;
          } else if (typeof data === 'string') {
            currentStatus = data;
          } else {
            currentStatus = 'disconnected';
          }
        } else {
          currentStatus = 'disconnected';
        }
        
        updateStatusUI();
        log('Status set to: ' + currentStatus);
      });
      unsubscribers.push(() => statusRef.off());
      
      // Listen to pending queue
      const pendingRef = sessionRef.child('pendingQueue');
      pendingRef.on('value', (snapshot) => {
        const data = snapshot.val();
        const newQueue = data ? Object.values(data) : [];
        log('Pending update: ' + newQueue.length + ' offers');
        
        // Check for NEW offers
        const newCount = newQueue.length;
        const newOfferIds = new Set(newQueue.map(o => o.id));
        
        // Find offers we haven't seen
        let newOffersFound = 0;
        newQueue.forEach(offer => {
          if (offer.id && !lastKnownOfferIds.has(offer.id)) {
            newOffersFound++;
            log('NEW offer detected: ' + offer.id + ' - ' + (offer.summary || 'no summary'));
          }
        });
        
        // Send notification ONLY for new offers (not approvals)
        if (!isFirstLoad && newOffersFound > 0) {
          const latestOffer = newQueue[newQueue.length - 1];
          log('Sending notification for new offer');
          sendNotification(
            'üîî New Offer!',
            latestOffer.summary || 'A new offer is waiting'
          );
        }
        
        // Update known offers
        lastKnownOfferIds = newOfferIds;
        localStorage.setItem('wor_known_offers', JSON.stringify([...newOfferIds]));
        
        pendingQueue = newQueue;
        lastPendingCount = newCount;
        renderPendingQueue();
        isFirstLoad = false;
      });
      unsubscribers.push(() => pendingRef.off());
      
      // Listen to completed
      const completedRef = sessionRef.child('completedToday');
      completedRef.on('value', (snapshot) => {
        const data = snapshot.val();
        completedToday = data ? Object.values(data) : [];
        renderCompletedList();
        log('Completed: ' + completedToday.length);
      });
      unsubscribers.push(() => completedRef.off());
      
      // Listen to approval requests (NO notifications - just UI update)
      const approvalRef = sessionRef.child('approvalRequest');
      approvalRef.on('value', (snapshot) => {
        const newApproval = snapshot.val();
        log('Approval update: ' + (newApproval ? newApproval.type : 'null'));
        
        // If null, clear approval UI
        if (!newApproval) {
          currentApproval = null;
          approvalSection.classList.add('hidden');
          approvalSection.innerHTML = '';
          return;
        }
        
        // NO notification for approvals - just update UI
        currentApproval = newApproval;
        renderApproval();
      });
      unsubscribers.push(() => approvalRef.off());
      
      // Listen to approval response (to clear UI when extension responds)
      const responseRef = sessionRef.child('approvalResponse');
      responseRef.on('value', (snapshot) => {
        if (snapshot.val()) {
          log('Approval response detected, clearing UI');
          currentApproval = null;
          approvalSection.classList.add('hidden');
          approvalSection.innerHTML = '';
        }
      });
      unsubscribers.push(() => responseRef.off());
      
      // Mark as connected
      sessionRef.child('remoteConnected').set(true);
      sessionRef.child('remoteConnected').onDisconnect().set(false);
      
      // Start status heartbeat polling (backup in case realtime listener misses updates)
      startStatusHeartbeat();
      
      showToast('Connected!');
      log('Subscribed to session');
    }
    
    // Status heartbeat - polls status every 3 seconds as backup
    let statusHeartbeatInterval = null;
    
    function startStatusHeartbeat() {
      stopStatusHeartbeat();
      
      statusHeartbeatInterval = setInterval(async () => {
        if (!sessionId) return;
        
        try {
          const response = await fetch(`https://wor-remote-default-rtdb.europe-west1.firebasedatabase.app/sessions/${sessionId}/status.json`);
          const data = await response.json();
          
          if (data) {
            let newStatus;
            if (typeof data === 'object' && data.status) {
              newStatus = data.status;
            } else if (typeof data === 'string') {
              newStatus = data;
            }
            
            if (newStatus && newStatus !== currentStatus) {
              log('Heartbeat detected status change: ' + currentStatus + ' -> ' + newStatus);
              currentStatus = newStatus;
              updateStatusUI();
              
              // Also check if we should clear approval UI
              if (newStatus === 'monitoring' || newStatus === 'stopped') {
                // Clear any lingering approval UI
                if (currentApproval) {
                  log('Heartbeat: clearing approval UI since status is ' + newStatus);
                  currentApproval = null;
                  approvalSection.classList.add('hidden');
                  approvalSection.innerHTML = '';
                }
              }
            }
          }
        } catch (err) {
          // Silent fail for heartbeat
        }
      }, 3000); // Every 3 seconds
    }
    
    function stopStatusHeartbeat() {
      if (statusHeartbeatInterval) {
        clearInterval(statusHeartbeatInterval);
        statusHeartbeatInterval = null;
      }
    }
    
    // Manual refresh status - force fetch from Firebase
    async function refreshStatus() {
      if (!sessionId) {
        showToast('Not connected');
        return;
      }
      
      log('Manual status refresh...');
      showToast('Refreshing...');
      
      try {
        const response = await fetch(`https://wor-remote-default-rtdb.europe-west1.firebasedatabase.app/sessions/${sessionId}/status.json`);
        const data = await response.json();
        
        if (data) {
          let newStatus;
          if (typeof data === 'object' && data.status) {
            newStatus = data.status;
          } else if (typeof data === 'string') {
            newStatus = data;
          }
          
          if (newStatus) {
            log('Refreshed status: ' + newStatus);
            currentStatus = newStatus;
            updateStatusUI();
            
            // Clear approval if back to monitoring
            if (newStatus === 'monitoring' || newStatus === 'stopped') {
              currentApproval = null;
              approvalSection.classList.add('hidden');
              workingOfferId = null;
              renderPendingQueue();
            }
            
            showToast('Status: ' + newStatus);
          }
        }
      } catch (err) {
        log('Refresh error: ' + err.message);
        showToast('Refresh failed');
      }
    }
    
    // Update status UI
    function updateStatusUI() {
      const statusMap = {
        'stopped': { text: 'üî¥ Stopped', class: 'stopped' },
        'monitoring': { text: 'üü¢ Monitoring', class: 'monitoring' },
        'paused': { text: 'üü° Paused', class: 'paused' },
        'processing': { text: 'üîµ Processing', class: 'processing' },
        'awaiting_approval': { text: 'üü† Awaiting', class: 'awaiting' },
        'disconnected': { text: '‚ö´ Disconnected', class: 'disconnected' }
      };
      
      const status = statusMap[currentStatus] || statusMap.disconnected;
      statusBadge.textContent = status.text;
      statusBadge.className = 'status-badge ' + status.class;
      
      // Clear working offer when back to monitoring or stopped
      if (currentStatus === 'monitoring' || currentStatus === 'stopped' || currentStatus === 'paused') {
        if (workingOfferId) {
          log('Task completed - clearing workingOfferId');
          workingOfferId = null;
          renderPendingQueue(); // Re-render to enable buttons
        }
      }
      
      // Update buttons
      const btnRun = document.getElementById('btn-run');
      const btnPause = document.getElementById('btn-pause');
      const btnStop = document.getElementById('btn-stop');
      
      btnRun.disabled = (currentStatus === 'monitoring' || currentStatus === 'processing');
      btnPause.disabled = (currentStatus !== 'monitoring');
      btnStop.disabled = (currentStatus === 'stopped');
    }
    
    // Render pending queue
    function renderPendingQueue() {
      const badge = document.getElementById('pending-badge');
      badge.textContent = pendingQueue.length > 0 ? `(${pendingQueue.length})` : '';
      
      if (pendingQueue.length === 0) {
        pendingList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No pending offers</p>
          </div>
        `;
        return;
      }
      
      pendingList.innerHTML = pendingQueue.map(offer => {
        const isWorking = workingOfferId === offer.id;
        // Only disable the specific offer being worked on - don't rely on status
        const isDisabled = isWorking;
        
        return `
        <div class="queue-item${isWorking ? ' working' : ''}">
          <div class="queue-item-header">
            <span class="queue-item-title">${offer.summary || 'Offer'}${isWorking ? ' üîÑ' : ''}</span>
            <span class="queue-item-time">${formatTime(offer.addedAt || offer.timestamp)}</span>
          </div>
          <div class="queue-item-preview">${(offer.text || '').substring(0, 100)}...</div>
          <div class="queue-item-actions">
            <button class="btn btn-secondary" onclick="skipOffer('${offer.id}')"${isDisabled ? ' disabled' : ''}>Skip</button>
            <button class="btn btn-primary" onclick="workOffer('${offer.id}')"${isDisabled ? ' disabled' : ''}>${isWorking ? 'Working...' : 'Work'}</button>
          </div>
        </div>
      `}).join('');
    }
    
    // Render completed list
    function renderCompletedList() {
      const badge = document.getElementById('completed-badge');
      badge.textContent = completedToday.length > 0 ? `(${completedToday.length})` : '';
      
      if (completedToday.length === 0) {
        completedList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚úÖ</div>
            <p>No completed offers today</p>
          </div>
        `;
        return;
      }
      
      completedList.innerHTML = completedToday.map(offer => `
        <div class="queue-item">
          <div class="queue-item-header">
            <span class="queue-item-title">${offer.summary || 'Offer'}</span>
            <span class="queue-item-time">${formatTime(offer.completedAt)}</span>
          </div>
          <div class="queue-item-preview">Sent to: ${(offer.labels || []).join(', ') || 'N/A'}</div>
        </div>
      `).join('');
    }
    
    // Render approval request
    function renderApproval() {
      if (!currentApproval) {
        approvalSection.classList.add('hidden');
        return;
      }
      
      approvalSection.classList.remove('hidden');
      const type = currentApproval.type;
      let html = '';
      
      if (type === 'confirm_send') {
        html = `
          <div class="approval-card">
            <div class="approval-header">
              <span class="approval-type">üì® Confirm Send</span>
            </div>
            <div class="approval-title">Send to ${currentApproval.count || '?'} chats?</div>
            <div class="approval-subtitle">${currentApproval.label || ''}${currentApproval.skipped > 0 ? ` (${currentApproval.skipped} skipped)` : ''}</div>
            <div class="approval-actions">
              <button class="btn btn-danger" onclick="respondApproval(false)">Clear</button>
              <button class="btn btn-primary" onclick="respondApproval(true)">Send</button>
            </div>
          </div>
        `;
      } else if (type === 'exclusions') {
        const groups = currentApproval.groupNames || [];
        html = `
          <div class="approval-card">
            <div class="approval-header">
              <span class="approval-type">üö´ Exclusions</span>
            </div>
            <div class="approval-title">Label: ${currentApproval.label || ''}</div>
            ${groups.length > 0 ? `
              <div style="max-height:120px;overflow-y:auto;background:#111b21;border-radius:8px;padding:8px;margin:8px 0;">
                ${groups.map(g => `<span onclick="addToExclusion('${g.replace(/'/g, "\\'")}')" style="display:inline-block;background:#202c33;padding:4px 8px;border-radius:8px;margin:2px;font-size:12px;cursor:pointer;">${g}</span>`).join('')}
              </div>
            ` : ''}
            <input type="text" class="approval-input" id="exclusions-input" placeholder="Names to exclude (comma separated)">
            <div class="approval-actions">
              <button class="btn btn-secondary" onclick="respondApproval(null)">Cancel</button>
              <button class="btn btn-primary" onclick="respondApproval(document.getElementById('exclusions-input').value)">Continue</button>
            </div>
          </div>
        `;
      } else if (type === 'revision') {
        html = `
          <div class="approval-card">
            <div class="approval-header">
              <span class="approval-type">‚úèÔ∏è Revise Message</span>
            </div>
            <div class="approval-title">${currentApproval.label || ''} <span class="price-badge ${currentApproval.removePrice ? 'remove' : 'keep'}">${currentApproval.removePrice ? '-$' : '+$'}</span></div>
            ${currentApproval.queue > 0 ? `<div class="approval-subtitle">${currentApproval.queue} more labels after</div>` : ''}
            <textarea class="approval-textarea" id="revision-input">${currentApproval.text || ''}</textarea>
            <div class="approval-actions">
              <button class="btn btn-secondary" onclick="respondApproval(null)">Skip</button>
              <button class="btn btn-primary" onclick="respondApproval(document.getElementById('revision-input').value)">OK</button>
            </div>
          </div>
        `;
      } else if (type === 'label_selection') {
        const labels = currentApproval.labels || [];
        html = `
          <div class="approval-card">
            <div class="approval-header">
              <span class="approval-type">üè∑Ô∏è Select Labels</span>
            </div>
            <div class="label-list" id="label-list">
              ${labels.map((l, i) => `
                <div class="label-chip selected" data-index="${i}" onclick="toggleLabel(this)">
                  ${l.name || l} <span class="price-badge ${l.removePrice ? 'remove' : 'keep'}">${l.removePrice ? '-$' : '+$'}</span>
                </div>
              `).join('')}
            </div>
            <div class="approval-actions">
              <button class="btn btn-secondary" onclick="respondApproval([])">Skip</button>
              <button class="btn btn-primary" onclick="respondLabelSelection()">Process</button>
            </div>
          </div>
        `;
      }
      
      approvalSection.innerHTML = html;
    }
    
    function toggleLabel(el) {
      el.classList.toggle('selected');
    }
    
    function addToExclusion(name) {
      const input = document.getElementById('exclusions-input');
      if (!input) return;
      const current = input.value.trim();
      if (current.toLowerCase().includes(name.toLowerCase())) {
        showToast('Already added');
        return;
      }
      input.value = current ? current + ', ' + name : name;
      showToast('Added: ' + name);
    }
    
    function respondLabelSelection() {
      const selected = Array.from(document.querySelectorAll('.label-chip.selected'))
        .map(el => parseInt(el.dataset.index));
      if (selected.length === 0) {
        showToast('Select at least one label');
        return;
      }
      respondApproval(selected);
    }
    
    function respondApproval(response) {
      if (!sessionId) return;
      log('Sending response: ' + JSON.stringify(response));
      
      db.ref(`sessions/${sessionId}/approvalResponse`).set({
        response: response,
        timestamp: Date.now()
      });
      
      // Clear approval request
      db.ref(`sessions/${sessionId}/approvalRequest`).remove();
      
      // Clear local UI
      currentApproval = null;
      approvalSection.classList.add('hidden');
      approvalSection.innerHTML = '';
      
      showToast('Response sent!');
    }
    
    function sendCommand(command) {
      if (!sessionId) return;
      log('Sending command: ' + command);
      
      db.ref(`sessions/${sessionId}/command`).set({
        type: command,
        timestamp: Date.now()
      });
      showToast('Command: ' + command);
    }
    
    function workOffer(offerId) {
      if (!sessionId) return;
      
      // Prevent double-click on same offer
      if (workingOfferId === offerId) {
        log('Already working on this offer: ' + offerId);
        showToast('Already working on this offer');
        return;
      }
      
      // If clicking a different offer while one is working, clear the old one
      // (user might want to switch or the old task finished but UI didn't update)
      if (workingOfferId && workingOfferId !== offerId) {
        log('Switching from offer ' + workingOfferId + ' to ' + offerId);
      }
      
      log('Work offer: ' + offerId);
      workingOfferId = offerId;
      
      db.ref(`sessions/${sessionId}/command`).set({
        type: 'WORK_OFFER',
        offerId: offerId,
        timestamp: Date.now()
      });
      
      showToast('Working...');
      renderPendingQueue(); // Re-render to show working state
    }
    
    function skipOffer(offerId) {
      if (!sessionId) return;
      log('Skip offer: ' + offerId);
      
      db.ref(`sessions/${sessionId}/command`).set({
        type: 'SKIP_OFFER',
        offerId: offerId,
        timestamp: Date.now()
      });
      showToast('Skipped');
    }
    
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
      document.getElementById('tab-pending').classList.toggle('active', tab === 'pending');
      document.getElementById('tab-completed').classList.toggle('active', tab === 'completed');
    }
    
    function showToast(message) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    function showSettings() {
      document.getElementById('settings-modal').classList.remove('hidden');
    }
    
    function hideSettings() {
      document.getElementById('settings-modal').classList.add('hidden');
    }
    
    function copySessionId() {
      navigator.clipboard.writeText(sessionId).then(() => showToast('Copied!'));
    }
    
    function disconnect() {
      localStorage.removeItem('wor_session_id');
      localStorage.removeItem('wor_known_offers');
      sessionId = '';
      unsubscribers.forEach(unsub => unsub());
      unsubscribers = [];
      mainApp.classList.remove('active');
      connectionScreen.classList.remove('hidden');
      sessionInput.value = '';
      hideSettings();
      showToast('Disconnected');
    }
    
    function formatTime(timestamp) {
      if (!timestamp) return '';
      return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    // Keep connection alive
    setInterval(() => {
      if (sessionId) {
        db.ref(`sessions/${sessionId}/remoteConnected`).set(true);
      }
    }, 30000);
  </script>
</body>
</html>
