<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#111b21">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>WOR Remote</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #111b21;
      color: #e9edef;
      min-height: 100vh;
      padding-bottom: 70px;
    }
    
    .header {
      background: #202c33;
      padding: 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid #2a3942;
    }
    
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      background: #2a3942;
    }
    
    .status-badge.monitoring { background: #00a884; color: #111b21; }
    .status-badge.paused { background: #f7c32e; color: #111b21; }
    .status-badge.processing { background: #53bdeb; color: #111b21; }
    .status-badge.awaiting { background: #ff9500; color: #111b21; }
    .status-badge.stopped { background: #667781; }
    .status-badge.disconnected { background: #ea4b35; }
    
    .session-id-display {
      font-size: 11px;
      color: #8696a0;
      margin-top: 4px;
    }
    
    .controls {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #1f2c34;
    }
    
    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn-primary { background: #00a884; color: #111b21; }
    .btn-secondary { background: #2a3942; color: #e9edef; }
    .btn-danger { background: #ea4b35; color: #fff; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .tabs {
      display: flex;
      background: #202c33;
      border-bottom: 1px solid #2a3942;
    }
    
    .tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: none;
      color: #8696a0;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      color: #00a884;
      border-bottom-color: #00a884;
    }
    
    .tab-content {
      display: none;
      padding: 16px;
    }
    
    .tab-content.active { display: block; }
    
    .queue-item {
      background: #202c33;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
    }
    
    .queue-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .queue-item-title {
      font-weight: 600;
      font-size: 14px;
    }
    
    .queue-item-time {
      font-size: 11px;
      color: #8696a0;
    }
    
    .queue-item-preview {
      font-size: 13px;
      color: #8696a0;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .queue-item-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .queue-item-actions .btn {
      flex: 1;
      padding: 10px;
      font-size: 13px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #8696a0;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .approval-section {
      padding: 16px;
      background: #1f2c34;
      border-bottom: 1px solid #2a3942;
    }
    
    .approval-section.hidden { display: none; }
    
    .approval-card {
      background: #202c33;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #00a884;
    }
    
    .approval-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .approval-type {
      font-weight: 600;
      font-size: 14px;
    }
    
    .approval-time {
      font-size: 11px;
      color: #8696a0;
    }
    
    .approval-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .approval-subtitle {
      font-size: 13px;
      color: #8696a0;
      margin-bottom: 12px;
    }
    
    .approval-textarea {
      width: 100%;
      min-height: 120px;
      background: #111b21;
      border: 1px solid #2a3942;
      border-radius: 8px;
      padding: 12px;
      color: #e9edef;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 12px;
    }
    
    .approval-input {
      width: 100%;
      background: #111b21;
      border: 1px solid #2a3942;
      border-radius: 8px;
      padding: 12px;
      color: #e9edef;
      font-size: 14px;
      margin-bottom: 12px;
    }
    
    .approval-actions {
      display: flex;
      gap: 8px;
    }
    
    .label-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .label-chip {
      background: #2a3942;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .label-chip.selected {
      border-color: #00a884;
      background: #00a88420;
    }
    
    .price-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #00a884;
      color: #111b21;
    }
    
    .price-badge.remove { background: #ea4b35; color: #fff; }
    .price-badge.keep { background: #00a884; color: #111b21; }
    
    .connection-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .connection-screen.hidden { display: none; }
    
    .connection-logo {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .connection-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .connection-subtitle {
      color: #8696a0;
      margin-bottom: 24px;
      text-align: center;
    }
    
    .connection-input {
      width: 100%;
      max-width: 280px;
      padding: 16px;
      font-size: 24px;
      text-align: center;
      background: #202c33;
      border: 2px solid #2a3942;
      border-radius: 12px;
      color: #e9edef;
      letter-spacing: 8px;
      margin-bottom: 16px;
      text-transform: uppercase;
    }
    
    .connection-input:focus {
      outline: none;
      border-color: #00a884;
    }
    
    .connect-btn {
      width: 100%;
      max-width: 280px;
      padding: 16px;
      font-size: 16px;
    }
    
    .main-app { display: none; }
    .main-app.active { display: block; }
    
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #202c33;
      color: #e9edef;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, 10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
    
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    
    .settings-modal.hidden { display: none; }
    
    .settings-content {
      background: #202c33;
      border-radius: 16px;
      width: 90%;
      max-width: 340px;
      padding: 20px;
    }
    
    .settings-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .settings-group {
      margin-bottom: 16px;
    }
    
    .settings-label {
      font-size: 13px;
      color: #8696a0;
      margin-bottom: 8px;
    }
    
    .settings-value {
      background: #111b21;
      padding: 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 16px;
      letter-spacing: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .settings-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 20px;
    }
    
    .notification-banner {
      background: #00a884;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    
    .notification-banner.hidden { display: none; }
    
    .notification-banner-text {
      font-size: 13px;
      color: #111b21;
      font-weight: 500;
    }
    
    .notification-banner .btn {
      flex: 0;
      white-space: nowrap;
      background: #111b21;
      color: #e9edef;
    }
    
    .debug-log {
      background: #0a1014;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 11px;
      max-height: 150px;
      overflow-y: auto;
      color: #8696a0;
    }
    
    .debug-log.hidden { display: none; }
  </style>
</head>
<body>
  <!-- Connection Screen -->
  <div class="connection-screen" id="connection-screen">
    <div class="connection-logo">üì±</div>
    <div class="connection-title">WOR Remote</div>
    <div class="connection-subtitle">Enter the Session ID from your<br>Chrome extension to connect</div>
    <input type="text" class="connection-input" id="session-input" placeholder="XXXXXX" maxlength="6" autocomplete="off">
    <button class="btn btn-primary connect-btn" onclick="connect()">Connect</button>
  </div>
  
  <!-- Main App -->
  <div class="main-app" id="main-app">
    <!-- Header -->
    <div class="header">
      <div class="header-row">
        <h1>üì± WOR Remote</h1>
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="status-badge" id="status-badge">Connecting...</span>
          <button onclick="showSettings()" style="background:none;border:none;font-size:18px;cursor:pointer;">‚öôÔ∏è</button>
        </div>
      </div>
      <div class="session-id-display">Session: <span id="session-display">------</span></div>
    </div>
    
    <!-- Notification Banner -->
    <div class="notification-banner" id="notification-banner">
      <span class="notification-banner-text">üîî Enable notifications for new offers</span>
      <button class="btn" onclick="requestNotificationPermission()">Enable</button>
    </div>
    
    <!-- Approval Section -->
    <div class="approval-section hidden" id="approval-section"></div>
    
    <!-- Controls -->
    <div class="controls">
      <button class="btn btn-primary" id="btn-run" onclick="sendCommand('RUN')">‚ñ∂ Run</button>
      <button class="btn btn-secondary" id="btn-pause" onclick="sendCommand('PAUSE')">‚è∏ Pause</button>
      <button class="btn btn-danger" id="btn-stop" onclick="sendCommand('STOP')">‚èπ Stop</button>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="pending" onclick="switchTab('pending')">
        Pending <span id="pending-badge"></span>
      </button>
      <button class="tab" data-tab="completed" onclick="switchTab('completed')">
        Done <span id="completed-badge"></span>
      </button>
    </div>
    
    <!-- Pending Tab -->
    <div class="tab-content active" id="tab-pending">
      <div id="pending-list">
        <div class="empty-state">
          <div class="empty-state-icon">üì≠</div>
          <p>No pending offers</p>
        </div>
      </div>
    </div>
    
    <!-- Completed Tab -->
    <div class="tab-content" id="tab-completed">
      <div id="completed-list">
        <div class="empty-state">
          <div class="empty-state-icon">‚úÖ</div>
          <p>No completed offers today</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div class="settings-modal hidden" id="settings-modal">
    <div class="settings-content">
      <div class="settings-title">‚öôÔ∏è Settings</div>
      <div class="settings-group">
        <div class="settings-label">Session ID</div>
        <div class="settings-value">
          <span id="settings-session-id">------</span>
          <button class="btn btn-secondary" onclick="copySessionId()" style="padding:6px 12px;font-size:12px;">Copy</button>
        </div>
      </div>
      <div class="settings-group">
        <div class="settings-label">Notifications</div>
        <div class="settings-value">
          <span id="notification-status">Not enabled</span>
          <button class="btn btn-secondary" id="btn-test-notif" onclick="testNotification()" style="padding:6px 12px;font-size:12px;">Test</button>
        </div>
      </div>
      <div class="settings-group">
        <div class="settings-label">Debug Log</div>
        <div class="debug-log" id="debug-log"></div>
      </div>
      <div class="settings-actions">
        <button class="btn btn-secondary" onclick="hideSettings()">Close</button>
        <button class="btn btn-danger" onclick="disconnect()">Disconnect</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script>
    // Debug logging
    const debugLog = document.getElementById('debug-log');
    function log(msg) {
      console.log('[WOR]', msg);
      const time = new Date().toLocaleTimeString();
      debugLog.innerHTML = `${time}: ${msg}<br>` + debugLog.innerHTML;
      if (debugLog.children.length > 50) {
        debugLog.innerHTML = debugLog.innerHTML.split('<br>').slice(0, 50).join('<br>');
      }
    }
    
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBSOUq1_RXB8SpkDdRzSXgksBUudiV4l4g",
      authDomain: "wor-remote.firebaseapp.com",
      databaseURL: "https://wor-remote-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wor-remote"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    log('Firebase initialized');
    
    // State
    let sessionId = localStorage.getItem('wor_session_id') || '';
    let currentStatus = 'disconnected';
    let pendingQueue = [];
    let completedToday = [];
    let currentApproval = null;
    let unsubscribers = [];
    let lastKnownOfferIds = new Set(JSON.parse(localStorage.getItem('wor_known_offers') || '[]'));
    let notificationsEnabled = false;
    let isFirstLoad = true;
    
    // DOM elements
    const connectionScreen = document.getElementById('connection-screen');
    const mainApp = document.getElementById('main-app');
    const sessionInput = document.getElementById('session-input');
    const statusBadge = document.getElementById('status-badge');
    const sessionDisplay = document.getElementById('session-display');
    const pendingList = document.getElementById('pending-list');
    const completedList = document.getElementById('completed-list');
    const approvalSection = document.getElementById('approval-section');
    const notificationBanner = document.getElementById('notification-banner');
    
    // Check for saved session on load
    if (sessionId) {
      sessionInput.value = sessionId;
      connect();
    }
    
    // Check notification permission
    checkNotificationPermission();
    
    function checkNotificationPermission() {
      if (!('Notification' in window)) {
        log('Notifications not supported');
        notificationBanner.classList.add('hidden');
        document.getElementById('notification-status').textContent = 'Not supported';
        return;
      }
      
      log('Notification permission: ' + Notification.permission);
      
      if (Notification.permission === 'granted') {
        notificationsEnabled = true;
        notificationBanner.classList.add('hidden');
        document.getElementById('notification-status').textContent = 'Enabled ‚úì';
      } else if (Notification.permission === 'denied') {
        notificationBanner.classList.add('hidden');
        document.getElementById('notification-status').textContent = 'Blocked ‚úó';
      } else {
        document.getElementById('notification-status').textContent = 'Not enabled';
      }
    }
    
    function requestNotificationPermission() {
      log('Requesting notification permission...');
      
      if (!('Notification' in window)) {
        showToast('Notifications not supported on this device');
        return;
      }
      
      Notification.requestPermission().then(permission => {
        log('Permission result: ' + permission);
        
        if (permission === 'granted') {
          notificationsEnabled = true;
          notificationBanner.classList.add('hidden');
          document.getElementById('notification-status').textContent = 'Enabled ‚úì';
          showToast('Notifications enabled!');
          
          // Send test notification immediately
          sendNotification('WOR Remote', 'Notifications are now enabled! üéâ');
        } else {
          showToast('Permission denied. Check browser settings.');
        }
        checkNotificationPermission();
      }).catch(err => {
        log('Permission error: ' + err);
        showToast('Error requesting permission');
      });
    }
    
    function testNotification() {
      log('Testing notification...');
      sendNotification('Test Notification', 'If you see this, notifications work! üîî');
    }
    
    function sendNotification(title, body) {
      log('sendNotification called: ' + title);
      
      if (!('Notification' in window)) {
        log('Notifications not supported');
        return;
      }
      
      if (Notification.permission !== 'granted') {
        log('Notifications not granted');
        return;
      }
      
      try {
        // Vibrate
        if ('vibrate' in navigator) {
          navigator.vibrate([200, 100, 200]);
          log('Vibrated');
        }
        
        // Play sound (optional)
        try {
          const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp2ZlYyDfXd4gIiQkpGOiYR+eHV2eoCGiouKiIWBfXl2dXl+g4iLjIuJhYF9eXZ1eH2DiIuNjYuHg356d3Z5fYKHi42OjYqGgn56d3d7gIWKjI6OjImFgX17eHl8gYaJjI6OjYqGgn57eXl8gIWJjI6OjYqHg398enp8f4SIi42OjYuHhH98enp8f4OHi42OjouIhYF+e3p7foKGio2OjoyJhoN/fHt7fYGFiYyOjo2KiIWCf3x7fH6ChomMjo6NioiEgX58e3x+goaJjI6OjYqIhIF+fHt8foKGiYyOjo2KiIWBfnx7fH6ChomMjo6NioiFgX58e3x+goaJjI6OjYqIhYF+fHt8foKFiYyOjo2KiIWCf3x7fH6ChYmMjo6NioiFgX58e3x+goWJjI6OjYqIhYJ/fHt8fYKFiYyOjo2KiIWBfnx7fH6ChYmMjo6NioiFgn98fHx9goWJjI6OjYqIhYJ/fHx8fYKFiYyOjo2KiIWBfnx7fH6ChYmMjo6NioiFgX98e3x9goWJjI6OjYqIhYF+fHt8foKFiYyOjo2KiIWBfnx7fH6ChYmMjo6Ni4iFgX58e3x+goWJjI6Ojo2KiIWBfnx7fH6ChYmMjo6NioiFgX58e3x+goWJjI6OjYqIhYF+fHt8foKFiYyOjo2KiIWBfnx7fH6ChYmMjo6NioiFgX58e3x+goWJjI6OjYqI');
          audio.volume = 0.3;
          audio.play().catch(() => {});
        } catch(e) {}
        
        // Create notification
        const notification = new Notification(title, {
          body: body,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23111b21" width="100" height="100" rx="20"/><text x="50" y="65" font-size="50" text-anchor="middle">üì±</text></svg>',
          badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üì±</text></svg>',
          tag: 'wor-' + Date.now(),
          requireInteraction: true,
          silent: false
        });
        
        log('Notification created');
        
        notification.onclick = function() {
          log('Notification clicked');
          window.focus();
          notification.close();
        };
        
        notification.onerror = function(e) {
          log('Notification error: ' + e);
        };
        
      } catch (err) {
        log('Notification error: ' + err.message);
      }
    }
    
    // Connect to session
    function connect() {
      const input = sessionInput.value.trim().toUpperCase();
      if (input.length !== 6) {
        showToast('Please enter a 6-character Session ID');
        return;
      }
      
      sessionId = input;
      localStorage.setItem('wor_session_id', sessionId);
      log('Connecting to session: ' + sessionId);
      
      // Show main app
      connectionScreen.classList.add('hidden');
      mainApp.classList.add('active');
      sessionDisplay.textContent = sessionId;
      document.getElementById('settings-session-id').textContent = sessionId;
      
      // Subscribe to Firebase
      subscribeToSession();
    }
    
    // Subscribe to session data
    function subscribeToSession() {
      // Unsubscribe from any previous subscriptions
      unsubscribers.forEach(unsub => unsub());
      unsubscribers = [];
      isFirstLoad = true;
      
      const sessionRef = db.ref(`sessions/${sessionId}`);
      
      // Listen to status
      const statusRef = sessionRef.child('status');
      statusRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          currentStatus = data.status || 'disconnected';
          updateStatusUI();
          log('Status: ' + currentStatus);
        }
      });
      unsubscribers.push(() => statusRef.off());
      
      // Listen to pending queue
      const pendingRef = sessionRef.child('pendingQueue');
      pendingRef.on('value', (snapshot) => {
        const newQueue = snapshot.val() ? Object.values(snapshot.val()) : [];
        log('Pending queue updated: ' + newQueue.length + ' items');
        
        // Find NEW offers (not seen before)
        const newOfferIds = new Set(newQueue.map(o => o.id));
        const brandNewOffers = newQueue.filter(o => !lastKnownOfferIds.has(o.id));
        
        log('Brand new offers: ' + brandNewOffers.length);
        
        // Send notification for new offers (skip on first load)
        if (!isFirstLoad && brandNewOffers.length > 0) {
          const offer = brandNewOffers[0];
          log('Sending notification for: ' + (offer.summary || 'New offer'));
          sendNotification(
            'üîî New Offer!', 
            offer.summary || 'A new offer is waiting for you'
          );
        }
        
        // Update known offers
        lastKnownOfferIds = newOfferIds;
        localStorage.setItem('wor_known_offers', JSON.stringify([...newOfferIds]));
        
        pendingQueue = newQueue;
        renderPendingQueue();
        isFirstLoad = false;
      });
      unsubscribers.push(() => pendingRef.off());
      
      // Listen to completed
      const completedRef = sessionRef.child('completedToday');
      completedRef.on('value', (snapshot) => {
        completedToday = snapshot.val() ? Object.values(snapshot.val()) : [];
        renderCompletedList();
        log('Completed: ' + completedToday.length);
      });
      unsubscribers.push(() => completedRef.off());
      
      // Listen to approval requests
      const approvalRef = sessionRef.child('approvalRequest');
      approvalRef.on('value', (snapshot) => {
        const newApproval = snapshot.val();
        
        // Only notify if this is a NEW approval (not on first load)
        if (newApproval && !isFirstLoad && (!currentApproval || currentApproval.timestamp !== newApproval.timestamp)) {
          log('New approval request: ' + newApproval.type);
          const typeMap = {
            'confirm_send': 'üì® Confirm Send',
            'exclusions': 'üö´ Set Exclusions', 
            'revision': '‚úèÔ∏è Review Message',
            'label_selection': 'üè∑Ô∏è Select Labels'
          };
          sendNotification('Action Required', typeMap[newApproval.type] || 'Approval needed');
        }
        
        currentApproval = newApproval;
        renderApproval();
      });
      unsubscribers.push(() => approvalRef.off());
      
      // Set connected
      sessionRef.child('remoteConnected').set(true);
      sessionRef.child('remoteConnected').onDisconnect().set(false);
      
      showToast('Connected!');
      log('Subscribed to session');
    }
    
    // Update status UI
    function updateStatusUI() {
      const statusMap = {
        'stopped': { text: 'üî¥ Stopped', class: 'stopped' },
        'monitoring': { text: 'üü¢ Monitoring', class: 'monitoring' },
        'paused': { text: 'üü° Paused', class: 'paused' },
        'processing': { text: 'üîµ Processing', class: 'processing' },
        'awaiting_approval': { text: 'üü† Awaiting', class: 'awaiting' },
        'disconnected': { text: '‚ö´ Disconnected', class: 'disconnected' }
      };
      
      const status = statusMap[currentStatus] || statusMap.disconnected;
      statusBadge.textContent = status.text;
      statusBadge.className = 'status-badge ' + status.class;
      
      document.getElementById('btn-run').disabled = currentStatus === 'monitoring' || currentStatus === 'processing';
      document.getElementById('btn-pause').disabled = currentStatus !== 'monitoring';
      document.getElementById('btn-stop').disabled = currentStatus === 'stopped';
    }
    
    // Render pending queue
    function renderPendingQueue() {
      document.getElementById('pending-badge').textContent = pendingQueue.length > 0 ? `(${pendingQueue.length})` : '';
      
      if (pendingQueue.length === 0) {
        pendingList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No pending offers</p>
          </div>
        `;
        return;
      }
      
      pendingList.innerHTML = pendingQueue.map(offer => `
        <div class="queue-item">
          <div class="queue-item-header">
            <span class="queue-item-title">${offer.summary || 'Offer'}</span>
            <span class="queue-item-time">${formatTime(offer.timestamp)}</span>
          </div>
          <div class="queue-item-preview">${(offer.text || '').substring(0, 100)}...</div>
          <div class="queue-item-actions">
            <button class="btn btn-secondary" onclick="skipOffer('${offer.id}')">Skip</button>
            <button class="btn btn-primary" onclick="workOffer('${offer.id}')">Work</button>
          </div>
        </div>
      `).join('');
    }
    
    // Render completed list
    function renderCompletedList() {
      document.getElementById('completed-badge').textContent = completedToday.length > 0 ? `(${completedToday.length})` : '';
      
      if (completedToday.length === 0) {
        completedList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚úÖ</div>
            <p>No completed offers today</p>
          </div>
        `;
        return;
      }
      
      completedList.innerHTML = completedToday.map(offer => `
        <div class="queue-item">
          <div class="queue-item-header">
            <span class="queue-item-title">${offer.summary || 'Offer'}</span>
            <span class="queue-item-time">${formatTime(offer.completedAt)}</span>
          </div>
          <div class="queue-item-preview">Sent to: ${(offer.labels || []).join(', ') || 'N/A'}</div>
        </div>
      `).join('');
    }
    
    // Render approval request
    function renderApproval() {
      if (!currentApproval) {
        approvalSection.classList.add('hidden');
        return;
      }
      
      approvalSection.classList.remove('hidden');
      
      const type = currentApproval.type;
      let html = '';
      
      if (type === 'confirm_send') {
        html = `
          <div class="approval-card">
            <div class="approval-header">
              <span class="approval-type">üì® Confirm Send</span>
            </div>
            <div class="approval-title">Send to ${currentApproval.count} chats?</div>
            <div class="approval-subtitle">${currentApproval.label}${currentApproval.skipped > 0 ? ` (${currentApproval.skipped} skipped)` : ''}</div>
            <div class="approval-actions">
              <button class="btn btn-danger" onclick="respondApproval(false)">Clear</button>
              <button class="btn btn-primary" onclick="respondApproval(true)">Send</button>
            </div>
          </div>
        `;
      } else if (type === 'exclusions') {
        const groups = currentApproval.groupNames || [];
        html = `
          <div class="approval-card">
            <div class="approval-header">
              <span class="approval-type">üö´ Exclusions</span>
            </div>
            <div class="approval-title">Label: ${currentApproval.label}</div>
            ${groups.length > 0 ? `
              <div style="max-height:120px;overflow-y:auto;background:#111b21;border-radius:8px;padding:8px;margin:8px 0;">
                ${groups.map(g => `<span onclick="addToExclusion('${g.replace(/'/g, "\\'")}')" style="display:inline-block;background:#202c33;padding:4px 8px;border-radius:8px;margin:2px;font-size:12px;cursor:pointer;">${g}</span>`).join('')}
              </div>
            ` : ''}
            <input type="text" class="approval-input" id="exclusions-input" placeholder="Names to exclude (comma separated)">
            <div class="approval-actions">
              <button class="btn btn-secondary" onclick="respondApproval(null)">Cancel</button>
              <button class="btn btn-primary" onclick="respondApproval(document.getElementById('exclusions-input').value)">Continue</button>
            </div>
          </div>
        `;
      } else if (type === 'revision') {
        html = `
          <div class="approval-card">
            <div class="approval-header">
              <span class="approval-type">‚úèÔ∏è Revise Message</span>
            </div>
            <div class="approval-title">${currentApproval.label} <span class="price-badge ${currentApproval.removePrice ? 'remove' : 'keep'}">${currentApproval.removePrice ? '-$' : '+$'}</span></div>
            ${currentApproval.queue > 0 ? `<div class="approval-subtitle">${currentApproval.queue} more labels after</div>` : ''}
            <textarea class="approval-textarea" id="revision-input">${currentApproval.text || ''}</textarea>
            <div class="approval-actions">
              <button class="btn btn-secondary" onclick="respondApproval(null)">Skip</button>
              <button class="btn btn-primary" onclick="respondApproval(document.getElementById('revision-input').value)">OK</button>
            </div>
          </div>
        `;
      } else if (type === 'label_selection') {
        const labels = currentApproval.labels || [];
        html = `
          <div class="approval-card">
            <div class="approval-header">
              <span class="approval-type">üè∑Ô∏è Select Labels</span>
            </div>
            <div class="label-list" id="label-list">
              ${labels.map((l, i) => `
                <div class="label-chip selected" data-index="${i}" onclick="toggleLabel(this)">
                  ${l.name} <span class="price-badge ${l.removePrice ? 'remove' : 'keep'}">${l.removePrice ? '-$' : '+$'}</span>
                </div>
              `).join('')}
            </div>
            <div class="approval-actions">
              <button class="btn btn-secondary" onclick="respondApproval([])">Skip</button>
              <button class="btn btn-primary" onclick="respondLabelSelection()">Process</button>
            </div>
          </div>
        `;
      }
      
      approvalSection.innerHTML = html;
    }
    
    function toggleLabel(el) {
      el.classList.toggle('selected');
    }
    
    function addToExclusion(name) {
      const input = document.getElementById('exclusions-input');
      if (!input) return;
      const current = input.value.trim();
      if (current.toLowerCase().includes(name.toLowerCase())) {
        showToast('Already added');
        return;
      }
      input.value = current ? current + ', ' + name : name;
      showToast('Added: ' + name);
    }
    
    function respondLabelSelection() {
      const selected = Array.from(document.querySelectorAll('.label-chip.selected'))
        .map(el => parseInt(el.dataset.index));
      if (selected.length === 0) {
        showToast('Select at least one label');
        return;
      }
      respondApproval(selected);
    }
    
    function respondApproval(response) {
      if (!sessionId) return;
      log('Sending response: ' + JSON.stringify(response));
      
      db.ref(`sessions/${sessionId}/approvalResponse`).set({
        response: response,
        timestamp: Date.now()
      });
      
      db.ref(`sessions/${sessionId}/approvalRequest`).remove();
      approvalSection.classList.add('hidden');
      currentApproval = null;
      showToast('Response sent!');
    }
    
    function sendCommand(command) {
      if (!sessionId) return;
      log('Sending command: ' + command);
      
      db.ref(`sessions/${sessionId}/command`).set({
        type: command,
        timestamp: Date.now()
      });
      showToast('Command: ' + command);
    }
    
    function workOffer(offerId) {
      if (!sessionId) return;
      log('Work offer: ' + offerId);
      
      db.ref(`sessions/${sessionId}/command`).set({
        type: 'WORK_OFFER',
        offerId: offerId,
        timestamp: Date.now()
      });
      showToast('Working...');
    }
    
    function skipOffer(offerId) {
      if (!sessionId) return;
      log('Skip offer: ' + offerId);
      
      db.ref(`sessions/${sessionId}/command`).set({
        type: 'SKIP_OFFER',
        offerId: offerId,
        timestamp: Date.now()
      });
      showToast('Skipped');
    }
    
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
      document.getElementById('tab-pending').classList.toggle('active', tab === 'pending');
      document.getElementById('tab-completed').classList.toggle('active', tab === 'completed');
    }
    
    function showToast(message) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    function showSettings() {
      document.getElementById('settings-modal').classList.remove('hidden');
    }
    
    function hideSettings() {
      document.getElementById('settings-modal').classList.add('hidden');
    }
    
    function copySessionId() {
      navigator.clipboard.writeText(sessionId).then(() => showToast('Copied!'));
    }
    
    function disconnect() {
      localStorage.removeItem('wor_session_id');
      localStorage.removeItem('wor_known_offers');
      sessionId = '';
      unsubscribers.forEach(unsub => unsub());
      unsubscribers = [];
      mainApp.classList.remove('active');
      connectionScreen.classList.remove('hidden');
      sessionInput.value = '';
      hideSettings();
      showToast('Disconnected');
    }
    
    function formatTime(timestamp) {
      if (!timestamp) return '';
      return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    // Keep alive - prevent page from sleeping
    setInterval(() => {
      log('Keep alive ping');
    }, 30000);
  </script>
</body>
</html>
